<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- We create a lead graph to represent the number of created leads per month-->
        <record id="graph_bar_lead_per_month_count" model="ir.ui.view">
            <field name="name">crm.lead.per.month.count</field>
            <field name="model">crm.lead</field>
            <field name="arch" type="xml">
                <graph string="Created Leads per Month" type="bar" stacked="True">
                    <field name="create_date" type="row" interval="month"/>
                </graph>
            </field>
        </record>

        <!-- We create a lead graph to represent the number of created leads per month-->
        <record id="graph_lead_source_distribution" model="ir.ui.view">
            <field name="name">crm.lead.source.distribution</field>
            <field name="model">crm.lead</field>
            <field name="arch" type="xml">
                <graph string="Leads per Source" type="pie">
                    <field name="marketing_project_id" type="row"/>
                </graph>
            </field>
        </record>

        <!-- We create a pivot view as summary-->
        <record id="pivot_lead_analysis" model="ir.ui.view">
            <field name="name">pivot.lead.analysis</field>
            <field name="model">crm.lead</field>
            <field name="arch" type="xml">
                <pivot string="Leads" display_quantity="true">
                    <field name="marketing_project_id" type="row"/>
                    <field name="type" type="col"/>
                </pivot>
            </field>
        </record>

        <!-- We create a new dashboard -->
        <record id="dashboard_lead_flow" model="ir.ui.view">
            <field name="name">dashboard.lead.flow</field>
            <field name="model">crm.lead</field>
            <field name="arch" type="xml">
                <dashboard>
                    
                    <view type="graph" ref="vcls_marketing.graph_bar_lead_per_month_count" name="lead_per_month"/>

                    <group>
                        <widget name="pie_chart" title="Stage Distribution" attrs="{'groupby': 'lead_stage_id'}"/>
                        <widget name="pie_chart" title="Source Distribution" attrs="{'groupby': 'marketing_project_id'}"/>
                    </group>

                    <group>
                        <aggregate name="total_records" string="Total Records" group_operator="count_distinct" field="id" measure="__count__"/>
                        <aggregate name="leads" string="Leads" domain="[('type','=','lead')]" group_operator="count_distinct" field="id" measure="__count__"/>
                        <aggregate name="opportunities" string="Converted to Opps" field="id" domain="[('type','=','opportunity')]" group_operator="count"/>
                        <formula name="opportunity_percent" string="Conversion Ratio %" value="record.opportunities / record.leads" widget="percentage"/>
                        <aggregate name="unassigned" string="Unassigned Leads" field="id" domain="[('type','=','opportunity')]" group_operator="count"/>
                        <aggregate name="days_to_assign" string="Days to Assign" field="day_open" group_operator="avg" value_label="day(s)"/>
                        <aggregate name="days_to_convert" string="Days To Convert" group_operator="avg" field="days_to_convert"/>    
                    </group>

                    <view type="pivot" ref="vcls_marketing.pivot_lead_analysis" name="pivot_lead_analysis"/>
                    
                </dashboard>
            </field>
        </record>
        
    </data>
</odoo>