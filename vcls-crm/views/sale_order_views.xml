<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- We Override the form view -->
        <record model="ir.ui.view" id="view_order_form">
            <field name="name">sale.order.form</field>
            <field name="model">sale.order</field>
            <field name="priority">3000</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                
                <xpath expr="//group" position="replace">

                    <group>
                        <group string="Client">
                            <field name="partner_id" string="Client" widget="res_partner_many2one" domain="[('customer','=',True)]" context="{'search_default_customer':1, 'show_address': 1, 'show_vat': True}" options="{&quot;always_reload&quot;: True}"/>
                            <field name="partner_invoice_id" domain="['|',('parent_id','=',partner_id),('id','=',partner_id)]" groups="sale.group_delivery_invoice_address" context="{'default_type':'invoice'}" options="{&quot;always_reload&quot;: True}"/>
                            <field name="partner_shipping_id" string="Deliverable Address" invisible="0" domain="['|',('parent_id','=',partner_id),('id','=',partner_id)]" groups="sale.group_delivery_invoice_address" context="{'default_type':'delivery'}" options="{&quot;always_reload&quot;: True}"/>
                            <field name="validity_date" attrs="{'invisible': [('state', 'in', ['sale', 'done'])]}"/>
                            <field name="confirmation_date" attrs="{'invisible': [('state', 'in', ['draft', 'sent', 'cancel'])]}"/>
                            <!--<field name="opportunity_id" string="Related Opportunity" required="1" domain="[('partner_id','=',partner_id)]" options="{'no_create': True}"/>-->
                        </group>

                        <group string="Invoicing">
                            <field name="company_id" options="{'no_create': True}" required="True"/>
                            <field name="pricelist_id" groups="product.group_sale_pricelist"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="payment_term_id" options="{'no_create': True}"/>
                            <field name="project_id" options="{'no_create': True}"/>
                        </group>
                    </group>

                    <group>
                        <group string="Segmentation">
                            <field name="product_category_id" required='True'/>
                            <field name="business_mode" widget="radio"/>
                            <field name="deliverable_id" domain="[('product_category_id','=',product_category_id)]"/>
                            <field name="sale_order_template_id"  domain="[('product_category_id','=',product_category_id)]"/>
                        </group>

                        <group string="Operations">
                            <field name="expected_start_date"/>
                            <field name="expected_end_date"/>
                        </group>
                    </group>
                    
                </xpath>

                <xpath expr="//field[@name='order_line']//tree/field[@name='product_id']" position="replace">
                    <field name="product_id" options="{'no_create_edit':True}" attrs="{'readonly': [('product_updatable', '=', False)],'required': [('display_type', '=', False)],}" force_save="1"
                    context="{'search_default_group_category':1,'search_default_group_info':1,'tree_view_ref':'vcls-crm.product_tree_view','partner_id': parent.partner_id,'quantity': product_uom_qty,'pricelist': parent.pricelist_id,'uom':product_uom,'company_id': parent.company_id,'default_lst_price': price_unit,'default_description_sale': name,'vcls_search': True,'business_mode':parent.business_mode,'business_line':parent.product_category_id,'deliverable_id':parent.deliverable_id }"/>
                </xpath>

                <xpath expr="//page/field[@name='sale_order_option_ids']/.." position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>

            </field>
        </record>
        
        <record id="sale_order_template_view_form" model="ir.ui.view">
            <field name="name">sale.order.template.form</field>
            <field name="model">sale.order.template</field>
            <field name="priority">1</field>
            <field name="inherit_id" ref="sale_management.sale_order_template_view_form"/>
            <field name="arch" type="xml">
                <notebook name="main_book" position="before">
                    <group>
                        <group>
                            <label for="product_category_id"/>
                            <div id="product_category_id">
                                <field name="product_category_id" required='True'/>
                            </div>
                        </group>
                    </group>
                </notebook>
            </field>
        </record>

        <record id="sale_order_template_view_tree" model="ir.ui.view">
            <field name="name">sale.order.template.tree</field>
            <field name="model">sale.order.template</field>
            <field name="priority">1</field>
            <field name="inherit_id" ref="sale_management.sale_order_template_view_tree"/>
            <field name="arch" type="xml">
                <field name="name" position="after">
                    <field name="product_category_id"/>
                </field>
            </field>
        </record>

        <!-- 
        <record id="sale_order_form" model="ir.ui.view">
        <field name="name">sale.order.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            
        </field>
        </record>-->

        <record id="sale.view_sale_order_calendar" model="ir.ui.view">
            <field name="name">quotation_calendar</field>
            <field name="model">sale.order</field>
            <field name="arch" type="xml">
                <calendar string="Sales Orders" date_start="expected_start_date" color="state" mode="month">
                    <field name="name"/>
                    <field name="currency_id" invisible="1"/>
                    <field name="amount_total" widget="monetary"/>
                </calendar>
            </field>
        </record>

    </data>
</odoo>